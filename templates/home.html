<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home</title>
</head>
<body>
  <h2>Welcome to UNIVOICE, {{username}}</h2>
  <button id="new-post">Create a New Post</button>
  <button id="logout">Log Out</button>
  <hr />

  <!-- Filter dropdowns -->
  <div>
    <label for="status">Status:</label>
    <select id="status">
      <option value="">All</option>
      <option value="pending">Pending</option>
      <option value="eligible">Eligible</option>
      <option value="submitted">Submitted</option>
    </select>

    <label for="sort">Sort By:</label>
    <select id="sort">
      <option value="latest">Latest</option>
      <option value="upvotes">Most Upvoted</option>
    </select>
  </div>

  <hr />

  <!-- Where posts will be rendered -->
  <div id="posts-container"></div>

  <script>
    // 🔁 Handle logout
    document.getElementById("logout").addEventListener("click", async () => {
      const response = await fetch("/api/logout", { method: "POST" });
      if (response.ok) window.location.href = "/login";
    });

    // ➕ Handle new post
    document.getElementById("new-post").addEventListener("click", () => {
      window.location.href = "/new-post";
    });

    // 📦 Create a single post card
    function createPostCard(post) {
      const card = document.createElement("div");
      card.classList.add("post-card");

      card.innerHTML = `
        <h3>${post.title}</h3>
        <p>${post.content}</p>
        <p><strong>Status:</strong> ${post.status}</p>
        <p><strong>Upvotes:</strong> ${post.upvotes} | Comments: ${post.comments}</p>
        <p><em>Posted by ${post.username} • ${post.time_ago}</em></p>
        <button class="upvote-button" data-id="${post.id}">Upvote</button>
        <button class="comment-button" data-id="${post.id}">Comment</button>
        <hr>
      `;
      return card;
    }

    //  Load all posts based on status & sort filters
    async function loadPosts(status = "", sort = "latest") {
      try {
        const response = await fetch(`/api/posts?status=${status}&sort=${sort}`);
        if (!response.ok) {
          const error = await response.json();
          alert(error.message);
          return;
        }

        const data = await response.json();
        const postsContainer = document.getElementById("posts-container");
        postsContainer.innerHTML = "";

        data.posts.forEach(post => {
          const card = createPostCard(post);
          postsContainer.appendChild(card);
        });

        attachPostActions(); // 🎯 Attach actions to new buttons
      } catch (err) {
        console.error("Failed to load posts:", err);
      }
    }

    // 🎯 Attach upvote & comment actions
    function attachPostActions() {
      document.querySelectorAll(".upvote-button").forEach(button => {
        button.addEventListener("click", (e) => {
          const postId = e.target.dataset.id;
          console.log("⬆️ Upvote clicked for:", postId);
          // TODO: Call your upvote API here later
        });
      });

      document.querySelectorAll(".comment-button").forEach(button => {
        button.addEventListener("click", (e) => {
          const postId = e.target.dataset.id;
          console.log("💬 Comment clicked for:", postId);
          // TODO: Show comment modal or redirect later
        });
      });
    }

    // Filter change listeners
    document.getElementById("status").addEventListener("change", () => {
      const status = document.getElementById("status").value;
      const sort = document.getElementById("sort").value;
      loadPosts(status, sort);
    });

    document.getElementById("sort").addEventListener("change", () => {
      const status = document.getElementById("status").value;
      const sort = document.getElementById("sort").value;
      loadPosts(status, sort);
    });

    loadPosts();
  </script>
</body>
</html>

